name: Generate Release

on:
  workflow_call:
    inputs:
      release_branch:
        required: false
        type: string
        default: main
      environment:
        required: true
        type: string
        default: production


jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write       # Required to create tags/releases
      pull-requests: read   # Required to read commit history

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 # Updated to v4 (standard)
        with:
          fetch-depth: 0      # âš ï¸ Critical: Must fetch full history to see tags

      # ðŸŸ¢ REPLACEMENT: Robust Version Calculator
      # This calculates the next version (v1.0.0 -> v1.0.1) automatically
      - name: Calculate next version
        id: version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch   # ðŸ‘ˆ This ensures it increments to v1.0.1 if no 'feat' is found
          release_branches: main,develop
          pre_release_branches: develop
          append_to_pre_release_tag: staging
          dry_run: true         # We just want the number, we let the release step do the tagging

      # ðŸŸ¢ SIMPLIFICATION: You do NOT need a manual 'git tag/push' step.
      # The release action below creates the tag automatically.

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_tag }}
          name: "Release ${{ steps.version.outputs.new_tag }}"
          generate_release_notes: true
          # ðŸŸ¢ UPDATE: Mark as Prerelease if we are on Staging
          prerelease: ${{ inputs.environment == 'staging' }}
      
      - name: Notify Slack
        uses: techoabhishek/cicd-hub-repo/.github/actions/slack-notify@main
        with:
          status: 'success'
          slack_webhook: ${{ secrets.SLACK_WEBHOOK }}
          job_name: "ðŸš€ New Release: ${{ steps.version.outputs.new_tag }} (${{ inputs.environment }})"
          custom_text: |
            New ${{ inputs.environment }} release is live!
            *Version:* ${{ steps.version.outputs.new_tag }}
            *Notes:* <${{ steps.create_release.outputs.url }}|Click here for Changelog>