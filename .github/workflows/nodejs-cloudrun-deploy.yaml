# Hub reusable workflow: Build Docker image from specified folder, push to Artifact Registry, deploy to Cloud Run.

# Inputs:
#  - service_dir (path in caller repo to app, e.g. sample-node-app)
#  - project_id, region, image_repo (artifact registry repo name), service_name
#  - cloudrun_allow_unauth: "true" or "false" (defaults to "false")
#
on:
  workflow_call:
    inputs:
      service_dir:
        required: true
        type: string
      project_id:
        required: true
        type: string
      region:
        required: true
        type: string
      image_repo:
        required: true
        type: string
      service_name:
        required: true
        type: string
      environment:
        description: 'The GitHub Environment to deploy to (e.g., production)'
        required: false
        type: string
        default: ''

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Show inputs
        run: |
          echo "Inputs:"
          echo "service_dir=${{ inputs.service_dir }}"
          echo "project_id=${{ inputs.project_id }}"
          echo "region=${{ inputs.region }}"
          echo "image_repo=${{ inputs.image_repo }}"
          echo "service_name=${{ inputs.service_name }}"

      - name: Checkout caller repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Notify Build Start
        uses: techoabhishek/cicd-hub-repo/.github/actions/slack-notify@main
        with:
          status: 'started'
          slack_webhook: ${{ secrets.SLACK_WEBHOOK }}
          job_name: "Deploy: ${{ github.repository }}"

      - name: Ensure service directory exists
        run: |
          if [ ! -d "${{ inputs.service_dir }}" ]; then
            echo "ERROR: service_dir '${{ inputs.service_dir }}' not found."
            ls -la
            exit 1
          fi

      - name: Change to service directory
        run: |
          cd "${{ inputs.service_dir }}"
          echo "Now in: $(pwd)"
        shell: bash

      - name: Install dependencies if package.json exists
        run: |
          cd "${{ inputs.service_dir }}"
          if [ -f package.json ]; then
            echo "Installing npm dependencies..."
            npm install --omit=dev || true
          else
            echo "No package.json found — skipping npm install."
          fi
      
      - name: Running tests if test script exists
        run: |
          cd "${{ inputs.service_dir }}"
          if [ -f package.json ] && grep -q '"test":' package.json; then
            echo "Running npm test..."
            npm test || true
          else
            echo "No test script found in package.json — skipping tests."
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/864610185638/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: "github-action-cicd@prj-vonage-apigee-poc.iam.gserviceaccount.com"

      - name: Configure gcloud project
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ inputs.project_id }}
      
      - name: Configure Docker auth for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ inputs.region }}-docker.pkg.dev --quiet

      - name: Build & push Docker image to Artifact Registry
        id: build_push
        run: |
          echo "Building Docker image..."
      - name: Deploy to Cloud Run
        run: |
          echo "Deploying to Cloud Run service: ${{ inputs.service_name }} in region: ${{ inputs.region }}"


  post-deploy-notification-frm-hub:
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: always()
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Determine Notification Status
        id: status
        run: |
          DEPLOY_RESULT="${{ needs.build-and-deploy.result }}"
          
          # Default to the actual result
          FINAL_STATUS=$DEPLOY_RESULT

          if [ "$DEPLOY_RESULT" == "failure" ]; then
            echo "Detected failure. Setting status to rejected (per config)."
            FINAL_STATUS="rejected"
          fi
          
          echo "final_status=$FINAL_STATUS" >> $GITHUB_OUTPUT
      - name: Slack Notification
        uses: techoabhishek/cicd-hub-repo/.github/actions/slack-notify@main
        with:
          # This grabs the result ('success', 'failure', 'cancelled') from the previous job
          status: ${{ steps.status.outputs.final_status }}
          slack_webhook: ${{ secrets.SLACK_WEBHOOK }}
          job_name: "Deploy: ${{ github.repository }}"